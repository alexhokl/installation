#!/bin/bash

update_all() {
	install_bat
	install_step
	install_hexyl
	install_nvim
	install_k9s
	install_popeye
	install_octant
	install_stern
	install_sampler
	install_minikube
	install_git
	install_docker_compose
	install_ruby
	install_vault
	install_terraform
	install_light
	install_kind
	install_code_server
	install_protoc
	install_git_sizer
}

install_all() {
	install_nodejs
	install_bat
	install_slack
	install_azure_data_studio
	install_hexyl
	install_octant
	install_step
	install_minikube
	install_python
	install_nvim
	install_flutter
	install_k9s
	install_popeye
	install_android_studio
	install_azcopy
	install_kubectx
	install_icdiff
	install_lolcat
	install_have
	install_light
	install_speedtest
	install_stern
	install_sampler
	install_hey
	install_nuget
	install_docker_compose
	install_sqlpackage
	install_vault
	install_sc_im
	install_vscode_extensions
	install_ruby
	install_vim
	install_git
	install_gh
	install_go
	install_bb_pr
	install_terraform
	install_fzf
	install_krew
	install_kind
	install_code_server
	install_protoc
	install_git_sizer
	install_cargo
}

install_git() {
	_CURRENT_DIR=$PWD
	INSTALL_DIR=$(mktemp -d)
	BASH_COMPLETION_DIR=/etc/bash_completion.d
  source $HOME/git/installation/versions-on-github

	sudo apt purge -y git git-core
	sudo apt autoremove -y
	hash -r

  curl -o $INSTALL_DIR/git.tar.gz -sSL https://github.com/git/git/archive/v${VERSION_GIT_GIT}.tar.gz
	tar xvzf $INSTALL_DIR/git.tar.gz -C $INSTALL_DIR/
	cd $INSTALL_DIR/git-*
	make prefix=/usr/local all
	sudo make prefix=/usr/local install

	sudo curl -o $BASH_COMPLETION_DIR/git-completion.bash -sS https://raw.githubusercontent.com/git/git/master/contrib/completion/git-completion.bash

	cd $_CURRENT_DIR
}

install_docker_compose() {
	INSTALL_DIR=$(mktemp -d)
	LOCAL_BIN=/usr/local/bin
  BASH_COMPLETION_DIR=/etc/bash_completion.d
  source $HOME/git/installation/versions-on-github

	sudo curl -o $LOCAL_BIN/docker-compose -sSL "https://github.com/docker/compose/releases/download/${VERSION_DOCKER_COMPOSE}/docker-compose-$(uname -s)-$(uname -m)"
  sudo curl -o $BASH_COMPLETION_DIR/docker-compose -sS https://raw.githubusercontent.com/docker/compose/${VERSION_DOCKER_COMPOSE}/contrib/completion/bash/docker-compose
  sudo chmod a+x $LOCAL_BIN/docker-compose
}

install_ruby() {
	_CURRENT_DIR=$PWD
  source $HOME/git/installation/versions-on-github

	if [ ! -d $HOME/.rbenv ]; then
		git clone https://github.com/rbenv/rbenv.git $HOME/.rbenv
	else
		cd $HOME/.rbenv
		git pull
	fi
	if [ ! -d $HOME/.rbenv/plugins/ruby-build ]; then
		git clone https://github.com/rbenv/ruby-build.git $HOME/.rbenv/plugins/ruby-build
	else
		cd $HOME/.rbenv/plugins/ruby-build
		git pull
	fi

	$HOME/.rbenv/bin/rbenv init
	$HOME/.rbenv/bin/rbenv install $VERSION_RUBY_RUBY
	$HOME/.rbenv/bin/rbenv global $VERSION_RUBY_RUBY
	echo "gem: --no-document" > $HOME/.gemrc
	$HOME/.rbenv/versions/$VERSION_RUBY_RUBY/bin/gem install bundler
	$HOME/.rbenv/versions/$VERSION_RUBY_RUBY/bin/gem install travis

	cd $_CURRENT_DIR
}

install_python() {
	VERSION_PYTHON=3.7.8
	VERSION_PYTHON_MAJOR=3.7

	_CURRENT_DIR=$PWD
	INSTALL_DIR=$(mktemp -d)
	LOCAL_BIN=/usr/local/bin

	curl -o $INSTALL_DIR/python.tar.xz -sS https://www.python.org/ftp/python/${VERSION_PYTHON}/Python-${VERSION_PYTHON}.tar.xz
	tar -xf $INSTALL_DIR/python.tar.xz -C $INSTALL_DIR/
	cd $INSTALL_DIR/Python-${VERSION_PYTHON}
	./configure --enable-optimizations
	make
	sudo make install
	sudo update-alternatives --install /usr/bin/python python $LOCAL_BIN/python${VERSION_PYTHON_MAJOR} 1
	sudo update-alternatives --set python $LOCAL_BIN/python${VERSION_PYTHON_MAJOR}

	cd $_CURRENT_DIR

  python -m pip install --user -r $HOME/git/installation/requirements.txt
}

install_go() {
	VERSION_GOLANG=1.15.6

	GO_BIN_DIR=$HOME/git/bin

	INSTALL_DIR=$(mktemp -d)

	if [ ! -d $GO_BIN_DIR ]; then
		mkdir $GO_BIN_DIR
	fi
	curl -o $INSTALL_DIR/golang.tar.gz -sS https://storage.googleapis.com/golang/go${VERSION_GOLANG}.linux-amd64.tar.gz
	if [ -d /usr/local/go ]; then
		sudo rm -rf /usr/local/go
	fi
	sudo tar xvf $INSTALL_DIR/golang.tar.gz -C /usr/local/
}

install_vim() {
	_CURRENT_DIR=$PWD

	if [ -d $HOME/.vim ]; then
		rm -rf $HOME/.vim
	fi
	git clone --recursive https://github.com/alexhokl/.vim $HOME/.vim
	cd $HOME/.vim
	make install

	cd $_CURRENT_DIR
}

install_vscode_extensions() {
	for e in $(cat $HOME/git/installation/vscode-extensions.txt); do /usr/bin/code --force --install-extension $e; done
	mkdir -p $HOME/.config/Code/User
	/bin/cp -f $HOME/git/installation/vscode_settings.json $HOME/.config/Code/User/settings.json
}

install_sc_im() {
	_CURRENT_DIR=$PWD

	git clone https://github.com/jmcnamara/libxlsxwriter.git $HOME/git/libxlsxwriter
	cd $HOME/git/libxlsxwriter
	make
	sudo make install
	git clone https://github.com/andmarti1424/sc-im.git $HOME/git/sc-im
	cd $HOME/git/sc-im
	make
	sudo make install

	cd $_CURRENT_DIR
}

install_vault() {
	INSTALL_DIR=$(mktemp -d)
	LOCAL_BIN=/usr/local/bin
  source $HOME/git/installation/versions-on-github

	curl -o $INSTALL_DIR/vault.zip -sSL https://releases.hashicorp.com/vault/${VERSION_HASHICORP_VAULT}/vault_${VERSION_HASHICORP_VAULT}_linux_amd64.zip
	unzip $INSTALL_DIR/vault.zip
	sudo /bin/mv -f vault $LOCAL_BIN/
	$LOCAL_BIN/vault -autocomplete-install
}

install_sqlpackage() {
	INSTALL_DIR=$(mktemp -d)
	LOCAL_BIN=/usr/local/bin
  source $HOME/git/installation/versions-on-github

	curl -o $INSTALL_DIR/sqlpackage.zip -sSL https://go.microsoft.com/fwlink/?linkid=2087431
	unzip $INSTALL_DIR/sqlpackage.zip -d $INSTALL_DIR/sqlpackage
	chmod a+x $INSTALL_DIR/sqlpackage/sqlpackage
	sudo /bin/mv -f $INSTALL_DIR/sqlpackage /opt/
	sudo ln -s /opt/sqlpackage/sqlpackage $LOCAL_BIN/sqlpackage
}

install_azcopy() {
	_CURRENT_DIR=$PWD

	INSTALL_DIR=$(mktemp -d)
	LOCAL_BIN=/usr/local/bin

	curl -o $INSTALL_DIR/azcopy.tar.gz -sSL https://aka.ms/downloadazcopy-v10-linux
	tar xvzf $INSTALL_DIR/azcopy.tar.gz -C $INSTALL_DIR/
	cd $INSTALL_DIR/azcopy_*
	sudo /bin/mv -f azcopy $LOCAL_BIN/

	cd $_CURRENT_DIR
}

install_android_studio() {
	INSTALL_DIR=$(mktemp -d)
	LOCAL_BIN=/usr/local/bin
	INSTALL_PATH=/opt/android-studio

	curl -o $INSTALL_DIR/android-studio.tar.gz -sSL https://redirector.gvt1.com/edgedl/android/studio/ide-zips/4.1.1.0/android-studio-ide-201.6953283-linux.tar.gz
	if [ -d "$INSTALL_PATH" ]; then
		sudo rm -rf $INSTALL_PATH
	fi
	sudo tar xvzf $INSTALL_DIR/android-studio.tar.gz -C /opt
	if [ -L "$INSTALL_PATH/bin/studio.sh" ]; then
		sudo unlink $INSTALL_PATH/bin/studio.sh
	fi
	sudo ln -s $INSTALL_PATH/bin/studio.sh $LOCAL_BIN/studio.sh
}

install_popeye() {
	INSTALL_DIR=$(mktemp -d)
	LOCAL_BIN=/usr/local/bin
  source $HOME/git/installation/versions-on-github

	curl -o $INSTALL_DIR/popeye.tar.gz -sSL https://github.com/derailed/popeye/releases/download/v${VERSION_DERAILED_POPEYE}/popeye_Linux_x86_64.tar.gz
	tar xvzf $INSTALL_DIR/popeye.tar.gz -C $INSTALL_DIR/
	sudo /bin/mv -f $INSTALL_DIR/popeye $LOCAL_BIN/
}

install_k9s() {
	INSTALL_DIR=$(mktemp -d)
	LOCAL_BIN=/usr/local/bin
  source $HOME/git/installation/versions-on-github

	curl -o $INSTALL_DIR/k9s.tar.gz -sSL https://github.com/derailed/k9s/releases/download/v${VERSION_DERAILED_K9S}/k9s_Linux_x86_64.tar.gz
	tar xvzf $INSTALL_DIR/k9s.tar.gz -C $INSTALL_DIR/
	sudo /bin/mv -f $INSTALL_DIR/k9s $LOCAL_BIN/
}

install_flutter() {
	_CURRENT_DIR=$PWD

	_REPO_DIR=$HOME/git/flutter
	if [ -d $_REPO_DIR ]; then
		rm -rf $_REPO_DIR
	fi
	git clone https://github.com/flutter/flutter.git $_REPO_DIR
	cd $_REPO_DIR
	git checkout stable

	cd $_CURRENT_DIR
}

install_nvim() {
	INSTALL_DIR=$(mktemp -d)
  source $HOME/git/installation/versions-on-github

	curl -o $INSTALL_DIR/nvim.appimage -sSL https://github.com/neovim/neovim/releases/download/v${VERSION_NEOVIM_NEOVIM}/nvim.appimage
	chmod u+x $INSTALL_DIR/nvim.appimage
	sudo /bin/mv -f $INSTALL_DIR/nvim.appimage /usr/bin/nvim
}

install_nodejs() {
	curl -sL https://deb.nodesource.com/setup_10.x curl | sudo -E bash -
	sudo apt update
	sudo apt install -y nodejs
	sudo npm i -g $(cat $HOME/git/installation/npm-list.txt)
}

install_slack() {
	INSTALL_DIR=$(mktemp -d)

	VERSION_SLACK=4.2.0

	curl -o $INSTALL_DIR/slack.deb -sSL https://downloads.slack-edge.com/linux_releases/slack-desktop-${VERSION_SLACK}-amd64.deb
	sudo dpkg -i $INSTALL_DIR/slack.deb
}

install_bat() {
	INSTALL_DIR=$(mktemp -d)
  source $HOME/git/installation/versions-on-github

	curl -o $INSTALL_DIR/bat.deb -sSL https://github.com/sharkdp/bat/releases/download/v${VERSION_SHARKDP_BAT}/bat-musl_${VERSION_SHARKDP_BAT}_amd64.deb
	sudo dpkg -i $INSTALL_DIR/bat.deb
}

install_azure_data_studio() {
	INSTALL_DIR=$(mktemp -d)

	curl -o $INSTALL_DIR/azuredatastudio.deb -sSL https://go.microsoft.com/fwlink/?linkid=2148806
	sudo dpkg -i $INSTALL_DIR/azuredatastudio.deb
	for e in $(cat $HOME/git/installation/azuredatastudio.extensions); do /usr/bin/azuredatastudio --force --install-extension $e; done
}

install_hexyl() {
	INSTALL_DIR=$(mktemp -d)
  source $HOME/git/installation/versions-on-github

	curl -o $INSTALL_DIR/hexyl.deb -sSL https://github.com/sharkdp/hexyl/releases/download/v${VERSION_SHARKDP_HEXYL}/hexyl_${VERSION_SHARKDP_HEXYL}_amd64.deb
	sudo dpkg -i $INSTALL_DIR/hexyl.deb
}

install_octant() {
	INSTALL_DIR=$(mktemp -d)
  source $HOME/git/installation/versions-on-github

	curl -o $INSTALL_DIR/octant.deb -sSL https://github.com/vmware-tanzu/octant/releases/download/v${VERSION_VMWARE__TANZU_OCTANT}/octant_${VERSION_VMWARE__TANZU_OCTANT}_Linux-64bit.deb
	sudo dpkg -i $INSTALL_DIR/octant.deb
}

install_step() {
	INSTALL_DIR=$(mktemp -d)
  source $HOME/git/installation/versions-on-github

	curl -o $INSTALL_DIR/step.deb -sSL https://github.com/smallstep/cli/releases/download/v${VERSION_SMALLSTEP_CLI}/step-cli_${VERSION_SMALLSTEP_CLI}_amd64.deb
	sudo dpkg -i $INSTALL_DIR/step.deb
}

install_minikube() {
	INSTALL_DIR=$(mktemp -d)
  source $HOME/git/installation/versions-on-github

	curl -o $INSTALL_DIR/minikube.deb -sSL https://storage.googleapis.com/minikube/releases/latest/minikube_${VERSION_KUBERNETES_MINIKUBE}-0_amd64.deb
	sudo dpkg -i $INSTALL_DIR/minikube.deb
}

install_kubectx() {
	BASH_COMPLETION_DIR=/etc/bash_completion.d
	LOCAL_BIN=/usr/local/bin

	sudo curl -o $BASH_COMPLETION_DIR/kubectx.bash -sS https://raw.githubusercontent.com/ahmetb/kubectx/master/completion/kubectx.bash
	sudo curl -o $BASH_COMPLETION_DIR/kubens.bash -sS https://raw.githubusercontent.com/ahmetb/kubectx/master/completion/kubens.bash
	sudo curl -o $LOCAL_BIN/kubectx -sSL https://raw.githubusercontent.com/ahmetb/kubectx/master/kubectx
	sudo curl -o $LOCAL_BIN/kubens -sSL https://raw.githubusercontent.com/ahmetb/kubectx/master/kubens
	sudo chmod a+x $LOCAL_BIN/kubectx
	sudo chmod a+x $LOCAL_BIN/kubens
}

install_lolcat() {
	LOCAL_BIN=/usr/local/bin

	sudo curl -o $LOCAL_BIN/lolcat -sS https://raw.githubusercontent.com/tehmaze/lolcat/master/lolcat
	sudo chmod a+x $LOCAL_BIN/lolcat
}

install_have() {
	LOCAL_BIN=/usr/local/bin

	sudo curl -o $LOCAL_BIN/have -sSL https://misc.j3ss.co/binaries/have
	sudo chmod a+x $LOCAL_BIN/have
}

install_light() {
	INSTALL_DIR=$(mktemp -d)
	source $HOME/git/installation/versions-on-github

	curl -o $INSTALL_DIR/light.tar.gz -sSL https://github.com/haikarainen/light/archive/v${VERSION_HAIKARAINEN_LIGHT}.tar.gz
	tar xf $INSTALL_DIR/light.tar.gz -C $INSTALL_DIR/
	cd $INSTALL_DIR/light-*
	./configure --with-udev && make
	sudo make install
}

install_speedtest() {
	LOCAL_BIN=/usr/local/bin

	sudo curl -o $LOCAL_BIN/speedtest -sS https://raw.githubusercontent.com/sivel/speedtest-cli/master/speedtest.py
	sudo chmod a+x $LOCAL_BIN/speedtest
}

install_stern() {
	LOCAL_BIN=/usr/local/bin
  source $HOME/git/installation/versions-on-github

	sudo curl -o $LOCAL_BIN/stern -sSL https://github.com/wercker/stern/releases/download/${VERSION_WERCKER_STERN}/stern_linux_amd64
	sudo chmod a+x $LOCAL_BIN/stern
}

install_sampler() {
	LOCAL_BIN=/usr/local/bin
  source $HOME/git/installation/versions-on-github

	sudo curl -o $LOCAL_BIN/sampler -sSL https://github.com/sqshq/sampler/releases/download/v${VERSION_SQSHQ_SAMPLER}/sampler-${VERSION_SQSHQ_SAMPLER}-linux-amd64
	sudo chmod a+x $LOCAL_BIN/sampler
}

install_hey() {
	LOCAL_BIN=/usr/local/bin

	sudo curl -o $LOCAL_BIN/hey -sSL https://storage.googleapis.com/hey-release/hey_linux_amd64
	sudo chmod a+x $LOCAL_BIN/hey
}

install_nuget() {
	LOCAL_BIN=/usr/local/bin

	sudo curl -o $LOCAL_BIN/nuget.exe -sS https://dist.nuget.org/win-x86-commandline/latest/nuget.exe
}

install_bb_pr() {
	BASH_COMPLETION_DIR=/etc/bash_completion.d

	go get -u github.com/alexhokl/go-bb-pr
	sudo curl -o $BASH_COMPLETION_DIR/go-bb-pr-completion.bash -sS https://raw.githubusercontent.com/alexhokl/go-bb-pr/master/go-bb-pr-completion.bash
}

install_gh() {
	_CURRENT_DIR=$PWD

	_DIR=$HOME/git/cli
	if [ ! -d "$_DIR" ]; then
		git clone https://github.com/cli/cli.git $_DIR
		cd $_DIR
	else
		cd $_DIR
		git checkout trunk
		git pull origin trunk
	fi
	make
	/bin/cp -f ./bin/gh $HOME/git/bin/

	cd $_CURRENT_DIR
}

install_terraform() {
	LOCAL_BIN=/usr/local/bin
	INSTALL_DIR=$(mktemp -d)
  source $HOME/git/installation/versions-on-github

	curl -o $INSTALL_DIR/terraform.zip -sSL https://releases.hashicorp.com/terraform/${VERSION_HASHICORP_TERRAFORM}/terraform_${VERSION_HASHICORP_TERRAFORM}_linux_amd64.zip
	unzip $INSTALL_DIR/terraform.zip -d $INSTALL_DIR/
	sudo /bin/mv -f $INSTALL_DIR/terraform $LOCAL_BIN/
}

install_fzf() {
	_CURRENT_DIR=$PWD

	_DIR=$HOME/.fzf
	if [ ! -d "$_DIR" ]; then
		git clone --depth 1 https://github.com/junegunn/fzf.git $_DIR
		cd $_DIR
	else
		cd $_DIR
		git pull
	fi
  ./install

	cd $_CURRENT_DIR
}

install_krew() {
	set -x; cd "$(mktemp -d)" &&
  curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/krew.{tar.gz,yaml}" &&
  tar zxvf krew.tar.gz &&
  KREW=./krew-"$(uname | tr '[:upper:]' '[:lower:]')_amd64" &&
  "$KREW" install --manifest=krew.yaml --archive=krew.tar.gz &&
  "$KREW" update
}

install_kind() {
	INSTALL_DIR=$(mktemp -d)
  source $HOME/git/installation/versions-on-github

	curl -o $INSTALL_DIR/kind -sSL https://kind.sigs.k8s.io/dl/v${VERSION_KUBERNETES__SIGS_KIND}/kind-$(uname)-amd64
	chmod +x $INSTALL_DIR/kind
	sudo /bin/mv -f $INSTALL_DIR/kind $LOCAL_BIN/
}

install_code_server() {
	curl -fsSL https://code-server.dev/install.sh | sh
}

install_ripgrep() {
	DISTRIBUTION=$(. /etc/os-release; echo $ID)
	if [ "ubuntu" = ${DISTRIBUTION} ]; then
		INSTALL_DIR=$(mktemp -d)
		source $HOME/git/installation/versions-on-github

		curl -o $INSTALL_DIR/ripgrep.deb -sSL https://github.com/BurntSushi/ripgrep/releases/download/${VERSION_BURNTSUSHI_RIPGREP}/ripgrep_${VERSION_BURNTSUSHI_RIPGREP}_amd64.deb
		sudo dpkg -i $INSTALL_DIR/ripgrep.deb
	fi
}

install_redis_cli() {
	_CURRENT_DIR=$PWD

	INSTALL_DIR=$(mktemp -d)
	curl -o $INSTALL_DIR/redis-stable.tar.gz -sSL http://download.redis.io/redis-stable.tar.gz
	tar xvzf $INSTALL_DIR/redis-stable.tar.gz -C $INSTALL_DIR/
	cd $INSTALL_DIR/redis-stable
	make
	sudo make install

	cd $_CURRENT_DIR
}

install_protoc() {
	INSTALL_DIR=$(mktemp -d)
	LOCAL_BIN=/usr/local/bin
  source $HOME/git/installation/versions-on-github
	curl -o $INSTALL_DIR/protoc.zip -sSL https://github.com/protocolbuffers/protobuf/releases/download/v${VERSION_PROTOCOLBUFFERS_PROTOBUF}/protoc-${VERSION_PROTOCOLBUFFERS_PROTOBUF}-linux-x86_64.zip
	unzip $INSTALL_DIR/protoc.zip -d $INSTALL_DIR/
	sudo /bin/mv -f $INSTALL_DIR/bin/protoc $LOCAL_BIN/
	sudo /bin/mv -f $INSTALL_DIR/include/* /usr/local/include/
}

install_git_sizer() {
	INSTALL_DIR=$(mktemp -d)
	LOCAL_BIN=/usr/local/bin
  source $HOME/git/installation/versions-on-github
	curl -o $INSTALL_DIR/git-sizer.zip -sSL https://github.com/github/git-sizer/releases/download/v${VERSION_GITHUB_GIT__SIZER}/git-sizer-${VERSION_GITHUB_GIT__SIZER}-linux-amd64.zip
	unzip $INSTALL_DIR/git-sizer.zip -d $INSTALL_DIR/
	sudo /bin/mv -f $INSTALL_DIR/git-sizer $LOCAL_BIN/
}

install_cargo() {
	curl https://sh.rustup.rs -sSf | sh
}
